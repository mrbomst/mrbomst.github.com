<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>评测详情 - 兔兔助手</title>
	<meta name="format-detection" content="telphone=no" />
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<noscript><meta http-equiv="X-Frame-Options" content="deny" /></noscript>
	<link rel="stylesheet" href="tutu.css"/>
</head>
<body>
	<!-- Container -->
	<div id="container" class="container">
		<!-- content -->
		<div id="content" class="content">
			<!-- APP Info -->
			<div id="app_info" class="section app_info hide"></div>
			
			<!-- News -->
			<div id="fill_content" class="section news_content">
				<header>
					<h1><a href="javascript:;" title="返回">返回</a>Loading...</h1>
				</header>
			</div>
			
			<!--recommendRead-->
			<div id="recommendRead" class="section recommendRead hide"></div>
			
			<!-- Comments -->
			<div id="comments" class="section comments hide"></div>
			
			<!-- Related Apps -->
			<div id="related_apps" class="section related_apps hide">
				<header><h2>相关应用</h2></header>
				<div class="inner"><ul id="related_apps_list"></ul></div>
			</div>
		</div>
	</div>
	
	<div class="goBackBtn" title="返回顶部"><i></i></div>
	<!-- Tmpls -->
	
	<textarea id="app_info_tmpl" class="tmpl" style="display:none">
		<!--
		<div class="inner">
			<div class="app_detail">
				<figure class="pic" data-id="<%=appInfo.id%>" data-name="<%=appInfo.name%>"><img class="pic_hold" alt="<%=appInfo.name%>" src="images/place.png" longdesc="<%=appInfo.icon%>" /></figure>
				<strong class="tit"><%=appInfo.name%></strong>
				<span class="prop">版本<em><%=appInfo.version%>, <%=appInfo.size%></em></span>
				<span class="prop">已评论<em>(<%=ds.fitNumber(appInfo.commentCount)%>)</em></span>
				<span class="prop">已下载<em>(<%=ds.fitNumber(appInfo.downloadCount)%>)</em></span>
				<span class="star" title="<%=appInfo.rate%>分"><em style="width:<%=(10*appInfo.rate)%>%"></em></span>
			</div>
			<div class="btns">
				<a href="javascript:;" class="btn <%=(appInfo.status=="installed"?"run":"download")%>_btn" data-id="<%=appInfo.id%>" data-process="<%=appInfo.process%>"><i></i><span><%=(appInfo.status=="installed"?"打 开":"下 载")%></span></a>
				<a href="javascript:;" class="btn cmmt_btn" data-id="<%=appInfo.id%>"><i class="cmmt"></i><span>评 论</span><em><%=ds.fitNumber(commentCount)%></em></a>
			</div>
		</div>	
		-->
	</textarea>

	<textarea id="content_fill_tmpl" class="tmpl" style="display:none">
		<header>
			<h1><a href="javascript:;" title="返回">返回</a><%=title%></h1>
			<div class="props">
				<time><%=postdate%></time>
				<span class="view"><em>(<%=ds.fitNumber(viewCount)%>)</em></span>
				<span class="msg"><em>(<%=ds.fitNumber(commentCount)%>)</em></span>
			</div>
			<div class="catetory"><span><%=categorySource%></span></div>
		</header>
		<div class="inner"><%=ds.fixNewsContent(content)%></div>
		<div class="btns">
			<!-- <a href="javascript:;" class="btn"><span>阅读全部</span></a> -->
		</div>
	</textarea>
	<textarea id="recommendRead_tmpl" class="tmpl" style="display:none">
		<header><h2>推荐阅读</h2></header>
		<div class="inner">
			<ul>
				<%for(var item,i=0,len=Math.min(5, recommendReadO.length); i<len&&(item=recommendReadO[i]); i++){%>
					<li data-id="<%=item.id%>"><%=item.content%></li>
				<%}%>
			</ul>
		</div>
	</textarea>
	<textarea id="comments_tmpl" class="tmpl" style="display:none">
		<% if(comments.length <= 0){ %>
			<div class="add_comment">
				<a href="javascript:;"><span>写评论</span></a>
			</div>
		<% } else{ %>
			<header><h2>评论<em>(<%=ds.fitNumber(commentCount)%>)</em></h2></header>
			<div class="inner">
				<ul>
					<%for(var item,i=0,len=Math.min(3, comments.length); i<len&&(item=comments[i]); i++){%>
					<li id="comment_<%=item.id%>">
						<div class="user_info">
							<figure class="pic" data-uid="<%=item.uid%>" data-username="<%=item.username%>"><img src="images/userface.png" longdesc="<%=item.avatar%>" height="50" width="50" alt="<%=item.username%>" /></figure>
							<span class="username"><%=item.username%></span>
							<p>
								<time><%=item.postdate%></time>
								<span data-id="<%=item.id%>" class="lookDownBtn"><%=item.lookDown%></span>
								<span data-id="<%=item.id%>" class="praiseBtn"><%=item.praise%></span>
							</p>
							<span class="star" title="<%=item.rate%>分"><em style="width:<%=(10*item.rate)%>%"></em></span>
						</div>
						<div class="cmmt_inner"><%=item.content%></div>
					</li>
					<%}%>
				</ul>
			</div>
			<%if(comments.length>3){%>
			<div class="btns">
				<a href="javascript:;" class="btn"><span>更多评论</span></a>
			</div>
			<%}%>
            <!--
            <div class="add_comment">
				<a href="javascript:;"><span>写评论</span></a>
			</div>
            -->
		<% }%>
	</textarea>
	<!--
	<textarea id="related_apps_list_tmpl" class="tmpl" style="display:none">
		<%for(var item,i=0,len=apps.length; i<len&&(item=apps[i]); i++){%>
		<li id="related_app_<%=item.id%>" data-id="<%=item.id%>" data-name="<%=item.name%>">
			<a href="javascript:;" class="pic"><img src="images/place.png" longdesc="<%=item.icon%>" height="60" width="60" alt="<%=item.name%>" /></a>
			<a href="javascript:;" class="name"><%=item.name%></a>
		</li>
		<%}%>
	</textarea>
	-->
	<script type="text/javascript" src="jquery-1.7.min.js"></script>	
	<script type="text/javascript" src="ds.js"></script>
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript">
	ds.initBaseViewEvent();
	
	//ds.fitNumber, ds.fillComments, ds.fillLetatedApps
	;(function(){
		ds.mix({
			fitNumber: function(num){
				return String(~~num).replace(/(?:\d{3})+$/, function(a){
					return a.replace(/(\d{3})/g, function(a){
						return ','+a;
					});
				})
				.replace(/(^|\-)\,/g, '$1');
			},
			fillComments: function(data){
				var 
				panel = ds.$d('comments'),
				tmpl = ds.$d('comments_tmpl').value;
				if(data && data.comments){
					panel.innerHTML = ds.tmpl(tmpl, data);
					ds.removeClass(panel, 'hide');
					
					ds.lazyLoad(ds.$('#comments img'), function(){
						ds.addClass(this.parentNode, 'active');
					});
				}
			},
			fillrecommendRead: function(data){
				var 
				panel = ds.$d('recommendRead'),
				tmpl = ds.$d('recommendRead_tmpl').value;
				if(data && data.recommendReadO){
					panel.innerHTML = ds.tmpl(tmpl, data);
					ds.removeClass(panel, 'hide');
				}
			},
			fillRelatedApps: function(data){
				var 
				panel = ds.$d('related_apps_list'),
				tmpl = ds.$d('related_apps_list_tmpl').value;
				if(data && data.apps && data.apps.length){
					panel.innerHTML = ds.tmpl(tmpl, data);
					ds.removeClass('#related_apps', 'hide');

					ds.lazyLoad(ds.$('#related_apps img'), function(){
						ds.addClass(this.parentNode, 'active');
					});
				}
			}
		}, true);
	})();
	
	//ds.Circle
	;(function(){
		function Circle(ops){
			this.ops = ops = (ops || {});

			var elem = this.elem = document.createElement('span');
			elem.className = 'ds_circle';
			elem.innerHTML = '<span class="panel"><i class="border"></i></span><span class="panel"><i class="border"></i></span>';
			
			var circles = ds.$('.border', elem);
			this.leftCircle = circles[0];
			this.rightCircle = circles[1];
			this.circleSize = ops.size || 40;

			this.process = 0;
		}
		Circle.prototype = {
			constructor: Circle,
			setProcess: function(process){
				this.process = process = Math.max(0, Math.min(360, 3.6 * ~~process));

				ds[process>=180 ? 'addClass' : 'removeClass'](this.elem, 'ds_circle_ahalf');
				this.leftCircle.style.webkitTransform = 'rotate(' + process + 'deg)';
			}
		};
		ds.mix({ Circle: Circle });
	})();
	
	//一些操作
	ds.ready(function(){
		//App info
		ds.touchTarget('#app_info', 'a.btn');
		ds.delegate('#app_info', 'a.btn', 'tap', function(){
			var self = this, key = 'download';
			if(/\b(downloading|run|cmmt)_btn/.test(this.className)){
				var keyHash = {
					downloading: 'pauseDownload',
					cmmt: 'showComment',
					run: 'runApp'
				};
				key = keyHash[RegExp.$1];
				ds.notifyApp('wp://tutu?api=' + key, {
					id: this.getAttribute('data-id')
				}, function(){
					if(key === 'pauseDownload'){
						self.className = 'btn download_btn';
					}
				});
			}
			else if(this.className.indexOf('downloading') < 0){
				var circle;
				ds.net.open({
					url: 'wp://tutu?api=downloadApp',
					data: {
						id: this.getAttribute('data-id')
					},
					onready: function(){
						self.className = 'btn downloading_btn';
						
						circle = new ds.Circle();
						self.appendChild(circle.elem);
						circle.setProcess(~~self.getAttribute('data-process'));
					},
					onprocess: function(process){
						if(circle){
							circle.setProcess(process);
						}
					},
					ondone: function(status){
						if(status === 'success'){
							self.className = 'btn run_btn';
							self.innerHTML = '<i></i><span>打 开</span>';
						}
					}
				});
			}
		});
		ds.delegate('#app_info', 'figure.pic', 'tap', function(){
			ds.notifyApp('wp://tutu?api=showAppInfo', {
				name: this.getAttribute('data-name'),
				id: this.getAttribute('data-id')
			});
		});

		//New Content
		ds.delegate('#fill_content', '.btns a.btn', 'tap', function(){
			var panel = ds.$('#fill_content .inner')[0];
			this.parentNode.style.display = 'none';
			panel.style.height = '';
		});
		ds.onFill(function(data){
			var appPanel = ds.$d('app_info');
			ds.hide(appPanel);
			if(data.appInfo){
				tmpl = ds.$d('app_info_tmpl').value;
				appPanel.innerHTML = ds.tmpl(tmpl, data);
				ds.show(appPanel);
				
				ds.lazyLoad(ds.$('img', appPanel));
				//app download
				if(data.appInfo.status === 'downloading'){
					var btn = ds.$('a.download_btn', appPanel)[0];
					btn && ds.trigger(btn, 'tap');
				}
			}
			/*
			var 
			maxHeight = 360,
			shell = ds.$d('fill_content'),
			panel = ds.$('.inner', shell)[0],
			moreBtn = ds.$('.btns', shell)[0];
			if(panel.offsetHeight > maxHeight){
				panel.style.height = maxHeight + 'px';
			}
			else{
				ds.hide(moreBtn);
			}*/
		});
		
		//Comments
		ds.touchTarget('#comments', '.add_comment a');
		ds.delegate('#comments', 'figure.pic', 'tap', function(){
			ds.showUserInfo(this.getAttribute('data-uid'), this.getAttribute('data-username'));
		});
		ds.delegate('#comments', '.btns a.btn', 'tap', function(){
			ds.notifyApp('wp://tutu?api=showComment');
		});
		ds.delegate('#comments', '.add_comment a', 'tap', function(){
			ds.notifyApp('wp://tutu?api=showComment', { action: 'add' });
		});
		
		//点赞
		ds.delegate('#comments', '.praiseBtn', 'tap', function(){
			var startVal = this.innerHTML;
			this.innerHTML = parseInt(startVal) + 1;
			this.className = 'praiseBtn disabledBtn';
			ds.notifyApp('wp://tutu?api=commentsPraiseBtn', {
				id: this.getAttribute('data-id')
			});			
		});
		//点不攒同
		ds.delegate('#comments', '.lookDownBtn', 'tap', function(){
			var startVal = this.innerHTML;
			this.innerHTML = parseInt(startVal) + 1;
			this.className = 'lookDownBtn disabledBtn';
			ds.notifyApp('wp://tutu?api=commentslookDownBtn', {
				id: this.getAttribute('data-id')
			});						
		});
		
		
		
		//Related Apps
		ds.delegate('#related_apps', 'li', 'tap', function(){
			ds.notifyApp('wp://tutu?api=showAppInfo', {
				name: this.getAttribute('data-name'),
				id: this.getAttribute('data-id')
			});
		});
		//RecommendRead
		ds.delegate('#recommendRead', 'li', 'tap', function(){
			ds.notifyApp('wp://tutu?api=recommendReadInfo', {
				id: this.getAttribute('data-id')
			});			
		});
		//返回按钮 
		ds.delegate('#fill_content', 'h1', 'tap', function(){
			ds.notifyApp('wp://tutu?api=backHistory');			
		});
	});
	
	//Related Apps
	ds.ready(function(){
		var 
		shell = ds.$d('related_apps'),
		panel = ds.$('.inner', shell)[0],
		target = ds.$('ul', panel)[0],
		targetStyle = target.style;
		function setLeft(left){
			targetStyle.webkitTransform = 'translate3d(' + left + 'px, 0, 0)';
		}
		ds.on(panel, 'touchstart', function(e){
			if(e.changedTouches.length < 1){ return; }
			
			var 
			panelRect = panel.getBoundingClientRect(),
			targetRect = target.getBoundingClientRect();
			if(targetRect.width < panelRect.width){
				return;
			}
			
			var 
			allowOffset = 40,
			stouch = ds.mix({}, e.changedTouches[0]),
			leftOffset = stouch.pageX - targetRect.left,
			currLeft = targetRect.left - panelRect.left,
			minLeft = panelRect.width - targetRect.width,
			moveHandler = function(e){
				var touch = e.changedTouches[0];
				var x = (touch.pageX + ' - ' + stouch.pageX + ' - ' + touch.pageY  + ' - ' +  stouch.pageY);
				if(Math.abs(touch.pageX - stouch.pageX) > Math.abs(touch.pageY - stouch.pageY)){
					e.preventDefault();
					
					var left = touch.pageX - targetRect.left - leftOffset + currLeft;
					left = Math.min(allowOffset, Math.max(minLeft-allowOffset, left));
					setLeft(left);
				}
			};
			targetStyle.webkitTransitionDuration = 0;
			ds.on(panel, 'touchmove', moveHandler)
			.on(panel, 'touchend', function(){
				ds.un(panel, 'touchend', arguments.callee);
				ds.un(panel, 'touchmove', moveHandler);

				targetStyle.webkitTransitionDuration = '';

				var 
				targetRect = target.getBoundingClientRect(),
				left = targetRect.left - panelRect.left;
				if(left > 0 && left <= allowOffset){
					setLeft(0);
				}
				else if(left < minLeft){
					setLeft(minLeft);
				}
			});
		});
	});
	
	//图片加载，查看大图
	ds.ready(function(){
		var 
		imgBaseUrl = '',
		rsmile = /(?:\salt\s*=\s*"smile")/i;
		ds.onNewsImgMatch = function(src, p){
			var baseUrl = imgBaseUrl + 'images/';
			return rsmile.test(p) ? 
				'<img class="smile" alt="smile" src="' + baseUrl + 'place.png" longdesc="' + src + '" width="25" height="25">' :
				'<figure class="pic"><img class="pic_hold" alt="" src="' + baseUrl + 'img_holder.png" longdesc="' + src + '"></figure>';
		};

		var 
		shell = ds.$d('fill_content'),
		loadingUrl = imgBaseUrl + 'images/img_holder_loading.png',
		urlStrCache = '', urlArrCache = [];

		//检测图片带链接
		var rimglink = /\.(?:png|jpg|gif|svg)(?:$|\?)/i;
		function getImgLink(img){
			var c = 0, link  = img.parentNode;
			while(c++ < 3 && link.nodeName !== 'A'){
				link = link.parentNode;
			}
			if(link.nodeName === 'A' && !rimglink.test(link.href)){
				return link.href;
			}
			return null;
		}
		
		//查看大图
		function showGallery(img){
			var rect = img.getBoundingClientRect();
			ds.notifyApp('wp://forum?api=showPic', {
				urls: urlStrCache,
				currSrc: img.src,
				index: ~~img.getAttribute('data-index'),
				height: rect.height || img.offsetHeight,
				width: rect.width || img.offsetWidth,
				left: rect.left,
				top: rect.top
			});
		}

		//（重新）初始化图片加载等
		function initPicHandler(data){
			var 
			inx = 0,
			shellPics = ds.$('.inner img', shell),
			smileTextNode = document.createTextNode('[表情]');

			urlArrCache = [];
			ds.each(shellPics, function(i){
				if(this.className.indexOf('pic_hold') > -1){
					if(data.showPic){
						this.src = loadingUrl;
					}
					
					//如果有链接是否允许跳转，且不加入查看大图
					var link = getImgLink(this);
					if(!!link){
						this.setAttribute('data-link', link);
					}
					else{
						urlArrCache.push(encodeURIComponent(this.longDesc));
						this.setAttribute('data-index', inx++);
					}
				}
				else{
					if(!data.showPic && this.alt === 'smile'){
						this.parentNode.replaceChild(smileTextNode.cloneNode(), this);
					}
				}
			});
			urlStrCache = urlArrCache.join(',');

			//图片加载
			if(data.showPic){
				ds.lazyLoad(shellPics, function(data){
					this.style.backgroundSize = '';
					if(this.className.indexOf('pic_hold') > -1){
						this.className = '';
					}
				}, function(process){
					this.style.backgroundSize = '100% ' + (80-process) + '%';
				});
			}
		}

		//查看大图，手动加载图片
		ds.onFill(function(data, fillCount){
			initPicHandler(data);

			//首次初始化
			if(fillCount > 1){ return; }

			ds.delegate(shell, 'figure.pic img', 'tap', function(e){
				var link = this.getAttribute('data-link');
				//打开链接
				if(!!link){
					ds.openUrl(link);
				}
				//查看大图
				else if(~~this.getAttribute('data-loaded') !== 0){
					showGallery(this);
				}
				else{
					var self = this;
					this.src = loadingUrl;
					ds.loadImage(this.longDesc, function(data){
						self.className = '';
						self.src = data.localUrl;
						self.style.backgroundSize = '';
						
						self.setAttribute('data-loaded', data.loaded ? 2 : -1);
					}, function(process){
						self.style.backgroundSize = '100% ' + (80-process) + '%';
					});
					this.setAttribute('data-loaded', 1);
				}
			})
			//阻止figure.pic中a标签跳转
			.delegate(shell, 'figure.pic', 'click', function(e){
				e.preventDefault();
			});
		});
	});
	
	//iPad
	ds.ready(function(){
		if(ds.isIPad){
			ds.addClass(document.documentElement, 'ipad');
		}
	});
	
	//Test
	ds.ready(function(){
		return;
		//ds.addClass(document.body, 'landscape');
		ds.fill({
			title: '新产品：iPhone 5C 新产iPhone新产新产iPhone新产',
			postdate: '2013-9-16 20:11',
			categorySource:'攻略',
			content: '<p>威锋网 9 月 11 日消息 美国当地时间 9 月 10 日上午 10 点，苹果在总部库比蒂诺召开发布会。正如预期，本次发布会上苹果发布了两款全新的 iPhone 产品，iPhone 5S 和iPhone 5C。</p><img alt="" src="images/app_logo.png" /><p>威锋网 9 月 11 日消息 美国当地时间 9 月 10 日上午 10 点，苹果在总部库比蒂诺召开发布会。正如预期，本次发布会上苹果发布了两款全新的 iPhone 产品，iPhone 5S 和iPhone 5C。</p><p>威锋网 9 月 11 日消息 美国当地时间 9 月 10 日上午 10 点，苹果在总部库比蒂诺召开发布会。正如预期，本次发布会上苹果发布了两款全新的 iPhone 产品，iPhone 5S 和iPhone 5C</p>',
			viewCount: 1223,
			commentCount: 23456,
			appInfo: {
				id: 1,
				name: 'iPhone 5C',
				icon: 'images/app_logo.png',
				version: '4.2.0',
				size: '12.2MB',
				downloadUrl: '###',
				commentCount: 1234,
				downloadCount: 2345,
				rate: 6,
				status: 'downloading', //uninit, downloading, installed
				process: 40
			},
			showPic: true
		});
		ds.fillComments({
			commentCount: 1234,
			comments: [
				{
					id: 1,
					username: 'Username1',
					avatar: 'images/userface.gif',
					postdate: '9-13 14:20',
					praise: 1107,
					lookDown:12,
					rate: 7,
					content: '<p>巴西通过各种生物理念上市脱口秀恶搞图形处理测试结果出巴西通过各种生物理念上市脱口秀恶搞图</p>'
				},
				{id:2,username:'Username1',avatar:'images/userface.gif',postdate:'9-13 14:20',praise: 157,lookDown:2,rate:7,content:'<p>巴西通过各种生物理念上市脱口秀恶搞图形处理测试结果出巴西通过各种生物理念上市脱口秀恶搞图</p>'},{id:3,username:'Username1',avatar:'images/userface.gif',postdate:'9-13 14:20',praise: 157,lookDown:2,rate:7,content:'<p>巴西通过各种生物理念上市脱口秀恶搞图形处理测试结果出巴西通过各种生物理念上市脱口秀恶搞图</p>'},{id:4,username:'Username1',avatar:'images/userface.gif',postdate:'9-13 14:20',rate:7,content:'<p>巴西通过各种生物理念上市脱口秀恶搞图形处理测试结果出巴西通过各种生物理念上市脱口秀恶搞图</p>'},{id:5,username:'Username1',avatar:'images/userface.gif',postdate:'9-13 14:20',praise: 157,lookDown:2,rate:7,content:'<p>巴西通过各种生物理念上市脱口秀恶搞图形处理测试结果出巴西通过各种生物理念上市脱口秀恶搞图</p>'}
			]
		});
		ds.fillrecommendRead({
			recommendReadO:[
					{
						id:1,
						content:'新服火爆《梦幻西游》返利引热潮'
					},
					{
						id:2,
						content:'iPad大作《泰坦的黎明》电影级宣传片'
					},
					{
						id:3,
						content:'G5精品冒险解谜：神秘来信'
					},
					{
						id:4,
						content:'iPad大作《泰坦的黎明》电影级宣传片'
					},
					{
						id:5,
						content:'G5精品冒险解谜：神秘来信'
					}
				]
		});
		ds.fillRelatedApps({
			appCount: 4,
			apps: [
				{
					id: 1,
					name: 'iA Writer',
					icon: 'images/app_logo_s.png'
				},
				{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},
				{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},
				{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'},{id:1,name:'印象笔记印象笔记',icon:'images/app_logo_s.png'}
			]
		});
	});
	</script>
	<script type="text/javascript">
	//返回顶部
	jQuery(function($){
		$(window).scroll(function() {
			var topVal = $(this).scrollTop();
			if( topVal > 100){
				$('.goBackBtn').show();
			}else{
				$('.goBackBtn').hide();
			}
		});
		$('.goBackBtn').bind('click',function(){
			$(window).scrollTop(0);
		});
	});
	</script>
</body>
</html>